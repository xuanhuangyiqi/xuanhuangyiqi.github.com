
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>推送来电消息到桌面 - Htedsv Backyard</title>
	<meta name="author" content="htedsv">

	
	<meta name="description" content="Scenario 1:IT男有时候会把手机放在一个非常隐蔽的地方，然后专心致志的盯着屏幕写代码，这时来了重要电话，你却没听见。 Scenario 2:出门匆忙，手机忘了带，又不方便回去拿，如何及时知道有谁正在给你打电话? 于是写了以下脚本来实现推送来电信息到桌面的脚本。 前提 环境 mac: &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Htedsv Backyard" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript"
   src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Htedsv Backyard</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:xuanhuangyiqi.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		<a class="google" href="https://plus.google.com/110950069380933156197?rel=author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/htedsv" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/xuanhuangyiqi" title="GitHub">GitHub</a>
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:xuanhuangyiqi.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">推送来电消息到桌面</h2>
	<div class="entry-content"><blockquote>
  <p>Scenario 1:IT男有时候会把手机放在一个非常隐蔽的地方，然后专心致志的盯着屏幕写代码，这时来了重要电话，你却没听见。</p>
</blockquote>

<blockquote>
  <p>Scenario 2:出门匆忙，手机忘了带，又不方便回去拿，如何及时知道有谁正在给你打电话?</p>
</blockquote>

<p><img src="/images/original_ZIeB_7c5500000bcc118d.jpg" /></p>

<p>于是写了以下脚本来实现推送来电信息到桌面的脚本。
<!--more--></p>

<h2 id="section">前提 环境</h2>

<ul>
  <li>mac: python(twisted), growl</li>
  <li>vps: python(twisted)</li>
  <li>android: on{X}</li>
</ul>

<h2 id="section-1">思路</h2>
<p>为了能适应更多情况，我们假设手机及电脑可能不在同一个局域网内，那么显然他们之间没有一个简单的通信方式。所以要依靠VPS，当然如果你有独立的PHP空间，并且用PHP来实现也是一样的。</p>

<p>手机：考虑到只有手机向VPS的请求，而没有反向，所以使用UDP或者http请求比较方便。单独为这个脚本写一个Android程序成本有点高，于是使用了微软的<a href="http://onx.ms/" target="_blank">on{X}</a>服务，简单地说，它是一个Android上的ifttt，用户可以自己用脚本实现“trigger-&gt;service”的功能。简单了解之后，发现on{X}的网络服务只有http请求。</p>

<p>电脑：IP及端口经常变化，而且考虑到服务器的性能，不宜轮询，遂与服务器保持TCP连接，这样服务器同时也能接受http请求（http请求在网络层就是TCP请求）。</p>

<h2 id="section-2">实现</h2>
<p>使用了python的twisted框架，以下是代码：
&lt;pre class=&#8221;brush: python; gutter: true&#8221;&gt;#Client</p>

<p>import os
import time
import urllib
from twisted.internet import reactor
from twisted.internet.protocol import Factory, Protocol
from twisted.internet.endpoints import TCP4ClientEndpoint</p>

<p>class Greeter(Protocol):
    def sendMessage(self, msg):
        self.transport.write(&quot;%s\n&quot; % msg)
        pass</p>

<pre><code>def dataReceived(self, msg):
    msg = urllib.unquote(msg)
    os.system(&amp;quot;export G_TITLE=%s;growl %s&amp;quot;% (&amp;quot;From\ Your\ Phone&amp;quot;, msg))
</code></pre>

<p>class GreeterFactory(Factory):
    def buildProtocol(self, addr):
        return Greeter()</p>

<p>def gotProtocol(p):
    pass</p>

<p>point = TCP4ClientEndpoint(reactor, &quot;&lt;SERVER&gt;&quot;, &lt;PORT&gt;)
d = point.connect(GreeterFactory())
d.addCallback(gotProtocol)
reactor.run()&lt;/pre&gt;
&lt;pre class=&#8221;brush: python; gutter: true&#8221;&gt;#Server</p>

<p>from twisted.internet.protocol import Protocol, Factory
from twisted.internet.endpoints import TCP4ServerEndpoint
from twisted.internet import reactor</p>

<p>class Echo(Protocol):
    def sendMessage(self, msg):
        self.transport.write(&quot;%s&quot; % msg)</p>

<pre><code>def dataReceived(self, data):
    #self.transport.write(data)
    if data.startswith(&amp;#039;GET&amp;#039;):
        msg = data.split(&amp;#039;\n&amp;#039;)[0].split(&amp;#039; &amp;#039;)[1]
        msg = msg[6:]
        for x in self.factory.protocols:
            if x != self:
                x.sendMessage(msg)
def connectionLost(self, reason):
     &amp;#039;lost&amp;#039;
    self.factory.protocols.remove(self)
</code></pre>

<p>class EFactory(Factory):
    protocol = Echo
    def <strong>init</strong>(self, quote=None):
        self.quote = quote or &#8216;An&#8217;
        self.protocols = []
    def buildProtocol(self, addr):
        p = self.protocol()
        p.factory = self
        self.protocols.append(p)
        return p</p>

<p>while True:
    endpoint = TCP4ServerEndpoint(reactor, &lt;PORT&gt;)
    endpoint.listen(EFactory(&quot;Ok&quot;))
    reactor.run()
     &#8216;stop&#8217;&lt;/pre&gt;
&lt;pre class=&#8221;brush: javascript; gutter: true&#8221;&gt;//Android
device.telephony.on(&#8216;incomingCall&#8217;, function (signal) 
{
    var notification = device.notifications.createNotification(&#8216;Calling&#8217;);
    notification.show();
    device.ajax(
    {
      url: &#8216;http://&lt;SERVER&gt;:&lt;PORT&gt;/?msg=Call%20From:&#8217;+signal.phoneNumber,
      type: &#8216;GET&#8217;,
      headers: {
        &#8216;Content-Type&#8217;: &#8216;application/xml&#8217;
      }
    },
    function onSuccess(body, textStatus, response) {
      var parsedBody;
      if(!(body &amp;&amp; (parsedBody = JSON.parse(body)))) {
        var error = {};
        error.message = &#8216;invalid body format&#8217;;
        error.content = body;
          console.error(&#8216;error: &#8216;,error);
      }
      console.info(&#8216;successfully received http response!&#8217;);
      notification.content = &#8216;successfully received http response!&#8217;;
      notification.show();
    },
    function onError(textStatus, response) {
      var error = {};
      error.message = textStatus;
      error.statusCode = response.status;
        console.error(&#8216;error: &#8216;,error);
    });
});&lt;/pre&gt;</p>
<h2>难点</h2>
<p>值得一提的是小米的权限管理比较恶心，开始我的来电事件一直没有被捕捉到，就是因为被小米拦截了，并且没有给出任何提示。直到现在短信监听器依然不能用，应该是这部分API被锁在MIUI里面了。所以只是实现了来电提示，而没有短信提示。</p>

<p>on{X}的不提供urlencode功能，所以不能用来推送短信内容或者来电人姓名。</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2013-01-26T09:08:12+08:00" pubdate data-updated="true">Jan 26<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/android/'>Android</a>, <a class='category' href='/blog/categories/onx/'>onx</a>, <a class='category' href='/blog/categories/gong-ju/'>工具</a>, <a class='category' href='/blog/categories/tui-song/'>推送</a>


</div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    htedsv

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'htedsvbackyard';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://xuanhuangyiqi.github.io/blog/2013/01/26/tui-song-lai-dian-xiao-xi-dao-zhuo-mian/';
        var disqus_url = 'http://xuanhuangyiqi.github.io/blog/2013/01/26/tui-song-lai-dian-xiao-xi-dao-zhuo-mian/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-47274484-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>